@model DraftOrderModel
@using Nop.Core.Domain.Discounts;
@using Nop.Services

<input type="hidden" name="Id" value="@Model.Id" />

<div class="card-body" style="padding-top:0">
    <div class="card card-default">
        <div class="card-body">
            @*<div class="form-group row;">
            <div class="col-md-2" style="flex:0 0 4%">
            <div class="form-text-row">
            <span class="grid-report-item @( Model.PaymentStatus == "Paid" ? "green" : "")">@(string.Format("{0}", Model.PaymentStatus))</span>
            </div>
            </div>

            </div>*@

            <div style="padding-top:10px">
                <div style="display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    grid-template-rows: 1fr;
                                    grid-column-gap: 0px;
                                    grid-row-gap: 0px;
                                    height: 30px;">

                    <div style="grid-area: 1 / 1 / 2 / 2;">
                        <span>Subtotal</span>
                    </div>
                    <div style="grid-area: 1 / 2 / 2 / 3;">
                        <p>
                            <span>
                                @{
                                    var totalQuantity = 0;
                                    foreach (var item in Model.Items)
                                    {
                                        totalQuantity += item.Quantity;
                                    }
                                }
                                @totalQuantity @(totalQuantity == 1 ? "item" : "items")
                            </span>
                        </p>
                    </div>
                    <div style="grid-area: 1 / 3 / 2 / 4; justify-self:end ">
                        <span>
                            @Model.OrderSubtotalExclTax
                        </span>
                    </div>
                </div>
                <div style="display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    grid-template-rows: 1fr;
                                    grid-column-gap: 0px;
                                    grid-row-gap: 0px;
                                    height: 30px;">

                    <div style="grid-area: 1 / 1 / 2 / 2;">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addDiscountPopup" style="background:unset;border:0;padding:0;" data-backdrop="static" onclick="">
                            <span style="color:#2c6ecb">@(Model.CustomDiscountValue > 0 ? "Edit" : "Add") discount</span>
                        </button>
                    </div>
                    <div style="grid-area: 1 / 2 / 2 / 3;">
                        <p>
                            <span>

                            </span>
                        </p>
                    </div>
                    <div style="grid-area: 1 / 3 / 2 / 4; justify-self:end ">
                        <span>
                            @Model.CustomDiscount
                        </span>
                    </div>
                </div>
                <div style="display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    grid-template-rows: 1fr;
                                    grid-column-gap: 0px;
                                    grid-row-gap: 0px;
                                    height: 30px;">

                    <div style="grid-area: 1 / 1 / 2 / 2;">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addShippingPopup" style="background:unset;border:0;padding:0;" data-backdrop="static" onclick="">
                            <span style="color:#2c6ecb">@(Model.OrderShippingExclTaxValue > decimal.Zero ? "Edit" : "Add") shipping</span>
                        </button>
                    </div>
                    <div style="grid-area: 1 / 2 / 2 / 3;">
                        <p>
                            <span>
                                @Model.ShippingMethod
                            </span>
                        </p>
                    </div>
                    <div style="grid-area: 1 / 3 / 2 / 4; justify-self:end ">
                        <span>
                            @Model.OrderShippingInclTax
                        </span>
                    </div>
                </div>

                @*<div style="display: grid;
                grid-template-columns: repeat(3, 1fr);
                grid-template-rows: 1fr;
                grid-column-gap: 0px;
                grid-row-gap: 0px;
                height: 30px;">

                <div style="grid-area: 1 / 1 / 2 / 2;">
                <span>Original shipping</span>
                </div>
                <div style="grid-area: 1 / 2 / 2 / 3;">
                <p>
                <span>
                @Model.OriginalShippingMethod
                </span>
                </p>
                </div>
                <div style="grid-area: 1 / 3 / 2 / 4; justify-self:end ">
                <span>
                </span>
                </div>
                </div>*@

                @if (Model.DisplayTax && Model.TaxValue != 0)
                {
                    <div style="display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    grid-template-rows: 1fr;
                                    grid-column-gap: 0px;
                                    grid-row-gap: 0px;
                                    height: 30px;">

                        <div style="grid-area: 1 / 1 / 2 / 2;">
                            <span>Tax</span>
                        </div>
                        <div style="grid-area: 1 / 2 / 2 / 3;">
                            <p>
                                <span>
                                    WORK IN PROGRESS
                                </span>
                            </p>
                        </div>
                        <div style="grid-area: 1 / 3 / 2 / 4; justify-self:end ">
                            <span>
                                @Model.Tax
                            </span>
                        </div>
                    </div>
                }

                <div style="display: grid;
                                    grid-template-columns: repeat(3, 1fr);
                                    grid-template-rows: 1fr;
                                    grid-column-gap: 0px;
                                    grid-row-gap: 0px;
                                    height: 30px;">

                    <div style="grid-area: 1 / 1 / 2 / 2;">
                        <span>Total</span>
                    </div>
                    <div style="grid-area: 1 / 2 / 2 / 3;">
                        <p>
                            <span>

                            </span>
                        </p>
                    </div>
                    <div style="grid-area: 1 / 3 / 2 / 4; justify-self:end ">
                        <span>
                            @Model.OrderTotal
                        </span>
                    </div>
                </div>
            </div>
            <hr />
            @if (Model.OrderStatusId == 0)
            {
                <button asp-action="CreateOrder" type="submit" class="btn btn-primary" name="createOrder">Create Order</button>
            }
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addShippingPopup" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="min-width:38rem">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">Add shipping</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="column-gap:1rem;
                            display: grid;
                            grid-template-areas: 'name price';
                            grid-template-columns: .5fr .5fr;;">
                    <div style="grid-area: name">
                        <div style="box-sizing:border-box">
                            <div style="word-wrap: break-word;
                                        align-items: baseline;
                                        display: flex;
                                        flex-wrap: wrap;
                                        justify-content: space-between;
                                        overflow-wrap: break-word;
                                        word-break: break-word;">
                                <div>
                                    <label>
                                        Rate Name
                                    </label>
                                </div>

                            </div>
                            <div style="flex:1 1 auto;display:flex;z-index:20;line-height:1.85rem;font-size:1.05rem">
                                <div style="display:flex;flex-grow:1;">
                                    <input id="shippingRateName" autocomplete="off" type="text" style="width:100%;padding-left:10px" value="@Model.ShippingMethod" />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="grid-area: price;">
                        <div style="box-sizing:border-box">
                            <div style="word-wrap: break-word;
                                        align-items: baseline;
                                        display: flex;
                                        flex-wrap: wrap;
                                        justify-content: space-between;
                                        overflow-wrap: break-word;
                                        word-break: break-word;">
                                <div>
                                    <label>
                                        Price
                                    </label>
                                </div>

                            </div>
                            <div style="flex:1 1 auto;display:flex;z-index:20;line-height:1.85rem;font-size:1.05rem">
                                <div style="display:flex;flex-grow:1;position:relative;margin-left:-8px">
                                    <span style="position:relative;left:18px;display:inline-flex;align-items:center">$</span>
                                    <input id="shippingRatePrice" class="allow_decimal" placeholder="0.00" autocomplete="off" type="text" style="width:100%;padding-left:20px" onkeyup="" value="@Model.OrderShippingExclTaxValue" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancel" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateCustomShipping()">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="addDiscountPopup" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="min-width:38rem">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalCenterTitle">@(Model.CustomDiscountValue > 0 ? "Edit" : "Add") discount</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="column-gap:1rem;
                            display: grid;
                            grid-template-areas: 'type value';
                            grid-template-columns: .5fr .5fr;">
                    <div style="grid-area: type">
                        <div style="box-sizing:border-box">
                            <div style="word-wrap: break-word;
                                        align-items: baseline;
                                        display: flex;
                                        flex-wrap: wrap;
                                        justify-content: space-between;
                                        overflow-wrap: break-word;
                                        word-break: break-word;">
                                <div>
                                    <label>
                                        Discount type
                                    </label>
                                </div>

                            </div>
                            <div style="flex:1 1 auto;display:flex;z-index:20;line-height:1.85rem;font-size:1.05rem">
                                <div style="display:flex;flex-grow:1;">
                                    <nop-select asp-for="CustomDiscountId" asp-items="@await (((DraftDiscountType)Model.CustomDiscountId).ToSelectListAsync())" onchange="discountTypeChanged(this.value)" />
                                    <span asp-validation-for="CustomDiscountId"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="grid-area: value;">
                        <div style="box-sizing:border-box">
                            <div style="word-wrap: break-word;
                                        align-items: baseline;
                                        display: flex;
                                        flex-wrap: wrap;
                                        justify-content: space-between;
                                        overflow-wrap: break-word;
                                        word-break: break-word;">
                                <div>
                                    <label>
                                        Discount value
                                    </label>
                                </div>

                            </div>
                            <div id="discountValuePlaceholder">
                            </div>
                            @*<div style="flex:1 1 auto;display:flex;z-index:20;line-height:1.85rem;font-size:1.05rem">
                            <div style="display:flex;flex-grow:1;position:relative;margin-left:-8px">
                            <span style="position:relative;left:18px;display:inline-flex;align-items:center">$</span>
                            <input id="itemPrice" class="allow_decimal" placeholder="0.00" autocomplete="off" type="text" style="width:100%;padding-left:20px" onkeyup="" />
                            </div>
                            </div>*@
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                @if (Model.CustomDiscountValue > 0)
                {
                    <button type="button" class="btn btn-danger" onclick="removeDiscount()">Remove Discount</button>
                    <button id="btnDone" type="button" class="btn btn-secondary" onclick="updateDiscount()" data-dismiss="modal">Done</button>
                }
                else
                {
                    <button id="btnCancel" type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateDiscount()">Apply</button>
                }
            </div>
        </div>
    </div>
</div>

<div style="display:none;" id="discountCurrency">
    <div style="flex:1 1 auto;display:flex;z-index:20;line-height:1.85rem;font-size:1.05rem">
        <div style="display:flex;flex-grow:1;position:relative;margin-left:-8px">
            <span style="position:relative;left:18px;display:inline-flex;align-items:center">$</span>
            <input id="discountValue" class="allow_decimal" placeholder="0.00" autocomplete="off" type="text" style="width:100%;padding-left:20px" onkeyup="" value='@(Model.CustomDiscountValue > 0 ? Model.CustomDiscountValue : "")' />
        </div>
    </div>
</div>

<div style="display:none;" id="discountPercentage">
    <div style="flex:1 1 auto;display:flex;z-index:20;line-height:2.0rem;font-size:1.05rem;border-width:1px;border-style:solid;border-color:rgb(118,118,118);border-radius:3px;">
        <div style="display:flex;flex-grow:1;position:relative;">
            <input id="discountValue" class="allow_decimal" placeholder="0" autocomplete="off" type="number" style="width:100%;padding-left:20px;outline-width:0;border:none;" onkeyup="" value='@(Model.CustomDiscountValue > 0 ? Model.CustomDiscountValue : "")' />
            <span style="position:relative;margin-right:0.75rem;display:inline-flex;align-items:center">%</span>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        var discount = '@Model.CustomDiscountId';
        if(discount === '0')
            discount = '1';

        discountTypeChanged(discount);
    });

    function discountTypeChanged(type) {


        if (type === '@((int)DraftDiscountType.Amount)') {
            var discountCurrencySnippet = $("#discountCurrency").html();
            $("#discountValuePlaceholder").html(discountCurrencySnippet);
        }
        if (type === '@((int)DraftDiscountType.Percentage)') {
            var discountPercentageSnippet = $("#discountPercentage").html();
            $("#discountValuePlaceholder").html(discountPercentageSnippet);
        }
    }

    function updateDiscount() {
        var postData = {
            discountType: $("#CustomDiscountId").val(),
            draftOrderId: @Model.Id,
            discountValue: $("#discountValue").val()

        };
        sendDiscountUpdate(postData);
    }

    function removeDiscount() {
        var postData = {
            draftOrderId: @Model.Id,
        };
        sendDiscountUpdate(postData);
    }


    function sendDiscountUpdate(postData){

        addAntiForgeryToken(postData);
        $.ajax({
            cache: false,
            type: "POST",
            url: "@(Url.Action("UpdateDraftOrderDiscount", "Order"))",
            data: postData,
            traditional: true,

            error: function (jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            },
            success: function (data) {
                //console.log(data);

                $("#productPanel").html(data);
                if (typeof updateDraftPricing === "function") {
                    updateDraftPricing(draftOrderId)
                }

                $('.modal-backdrop').remove();
            }
        });
    }

    function updateCustomShipping() {

        var postData = {
            rateName: $("#shippingRateName").val(),
            draftOrderId: @Model.Id,
            rateValue: $("#shippingRatePrice").val()

        };


        addAntiForgeryToken(postData);
        $.ajax({
            cache: false,
            type: "POST",
            url: "@(Url.Action("UpdateDraftOrderShipping", "Order"))",
            data: postData,
            traditional: true,

            error: function (jqXHR, textStatus, errorThrown) {
                console.log(errorThrown);
            },
            success: function (data) {
                //console.log(data);

                $("#productPanel").html(data);
                if (typeof updateDraftPricing === "function") {
                    updateDraftPricing(draftOrderId)
                }

                $('.modal-backdrop').remove();
            }
        });
    }

</script>